<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar Colaboradores - MARH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .progress {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #007bff;
            height: 100%;
            transition: width 0.3s;
            width: 0%;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        .file-input-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-input-area:hover {
            background: #e8f0ff;
        }
        .file-input-area.dragover {
            border-color: #28a745;
            background: #f0fff0;
        }
        .hidden {
            display: none;
        }
        .excel-preview {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .excel-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        .excel-preview th, .excel-preview td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        .excel-preview th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .protected-employee {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
        }
        .to-delete-employee {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Limpeza de Colaboradores</h1>
        <p>Esta ferramenta permite limpar colaboradores criados durante testes.</p>
        
        <div class="stats" id="stats">
            <div class="stat">
                <div class="stat-number" id="total-employees">-</div>
                <div class="stat-label">Total de Colaboradores</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="protected-count">0</div>
                <div class="stat-label">Protegidos (Excel)</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="selected-count">0</div>
                <div class="stat-label">Para Deletar</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="deleted-count">0</div>
                <div class="stat-label">Deletados</div>
            </div>
        </div>

        <div class="file-input-area" id="file-drop-area">
            <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" class="hidden">
            <div>
                <h3>üìÑ Upload da Planilha de Prote√ß√£o</h3>
                <p>Arraste um arquivo Excel/CSV aqui ou clique para selecionar</p>
                <p style="font-size: 0.9em; color: #666;">
                    A planilha deve conter uma coluna com os nomes dos colaboradores que N√ÉO devem ser deletados
                </p>
                <button type="button" class="btn" onclick="document.getElementById('excel-file').click()">
                    üìÅ Selecionar Arquivo
                </button>
            </div>
        </div>

        <div id="excel-preview" class="excel-preview hidden">
            <h4>üëÄ Preview da Planilha:</h4>
            <div id="excel-content"></div>
            <div style="margin: 15px 0;">
                <label>Coluna com os nomes dos colaboradores:</label>
                <select id="name-column" class="btn" style="margin-left: 10px;">
                    <option value="">Selecione a coluna...</option>
                </select>
                <button id="apply-protection" class="btn" style="margin-left: 10px;">
                    üõ°Ô∏è Aplicar Prote√ß√£o
                </button>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <button id="load-employees" class="btn">üìä Carregar Colaboradores</button>
            <button id="select-unprotected" class="btn">üéØ Selecionar N√£o Protegidos</button>
            <button id="select-test-employees" class="btn">üß™ Selecionar Colaboradores de Teste</button>
            <button id="select-all" class="btn">‚òëÔ∏è Selecionar Todos</button>
            <button id="clear-selection" class="btn">üî≤ Limpar Sele√ß√£o</button>
            <button id="delete-selected" class="btn danger" disabled>üóëÔ∏è Deletar Selecionados</button>
        </div>

        <div class="progress" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="progress-text" style="text-align: center; margin: 10px 0;"></div>

        <div id="employee-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 20px 0;">
            <p style="text-align: center; color: #666;">Clique em "Carregar Colaboradores" para ver a lista</p>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        const API = 'https://marhbackend-production.up.railway.app/api';
        let TOKEN = localStorage.getItem('MARH_TOKEN') || null;
        let employees = [];
        let selectedEmployees = new Set();
        let protectedEmployees = new Set(); // Nomes dos colaboradores protegidos do Excel
        let excelData = null;
        let deletedCount = 0;

        // Verificar se tem token
        if (!TOKEN) {
            alert('‚ùå Token n√£o encontrado! Fa√ßa login no MARH primeiro.');
            window.location.href = 'index.html';
        }

        async function api(path, method = 'GET', body = null) {
            const response = await fetch(API + path, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + TOKEN
                },
                body: body ? JSON.stringify(body) : null
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            const contentType = response.headers.get('content-type');
            return contentType && contentType.includes('application/json') 
                ? response.json() 
                : response.text();
        }

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStats() {
            document.getElementById('total-employees').textContent = employees.length;
            document.getElementById('protected-count').textContent = protectedEmployees.size;
            document.getElementById('selected-count').textContent = selectedEmployees.size;
            document.getElementById('deleted-count').textContent = deletedCount;
        }

        async function loadEmployees() {
            try {
                log('üìä Carregando colaboradores...');
                employees = await api('/employees');
                log(`‚úÖ ${employees.length} colaboradores carregados`);
                renderEmployeeList();
                updateStats();
            } catch (error) {
                log(`‚ùå Erro ao carregar colaboradores: ${error.message}`);
                alert('Erro ao carregar colaboradores: ' + error.message);
            }
        }

        function renderEmployeeList() {
            const container = document.getElementById('employee-list');
            
            if (employees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum colaborador encontrado</p>';
                return;
            }

            container.innerHTML = employees.map(emp => {
                const isProtected = isEmployeeProtected(emp.name);
                const cssClass = isProtected ? 'protected-employee' : 
                               (selectedEmployees.has(emp.id) ? 'to-delete-employee' : '');
                
                return `
                <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;" class="${cssClass}">
                    <input type="checkbox" id="emp-${emp.id}" data-emp-id="${emp.id}" 
                           style="margin-right: 10px;" ${isProtected ? 'disabled title="Protegido pelo Excel"' : ''}>
                    <label for="emp-${emp.id}" style="flex: 1; cursor: pointer;">
                        <strong>${emp.name}</strong> - ${emp.email} 
                        <span style="color: #666; font-size: 0.9em;">
                            (${emp.position || 'Sem cargo'} - ${emp.department || 'Sem depto'})
                        </span>
                        ${isProtected ? '<span style="color: #28a745; font-weight: bold;"> üõ°Ô∏è PROTEGIDO</span>' : ''}
                    </label>
                </div>
            `;
            }).join('');

            // Adicionar event listeners para checkboxes
            container.querySelectorAll('input[type="checkbox"]:not([disabled])').forEach(checkbox => {
                checkbox.onchange = function() {
                    const empId = this.dataset.empId;
                    if (this.checked) {
                        selectedEmployees.add(empId);
                    } else {
                        selectedEmployees.delete(empId);
                    }
                    updateStats();
                    updateEmployeeVisuals();
                    document.getElementById('delete-selected').disabled = selectedEmployees.size === 0;
                };
            });
        }

        function updateEmployeeVisuals() {
            // Atualizar cores visuais
            employees.forEach(emp => {
                const div = document.querySelector(`#emp-${emp.id}`).parentElement;
                div.className = '';
                
                if (isEmployeeProtected(emp.name)) {
                    div.classList.add('protected-employee');
                } else if (selectedEmployees.has(emp.id)) {
                    div.classList.add('to-delete-employee');
                }
            });
        }

        function isEmployeeProtected(employeeName) {
            if (protectedEmployees.size === 0) return false;
            
            // Normalizar nome para compara√ß√£o (remover acentos, converter para min√∫sculo)
            const normalized = employeeName.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();
            
            for (let protectedName of protectedEmployees) {
                const normalizedProtected = protectedName.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .trim();
                
                // Verificar correspond√™ncia exata ou parcial
                if (normalized === normalizedProtected || 
                    normalized.includes(normalizedProtected) ||
                    normalizedProtected.includes(normalized)) {
                    return true;
                }
            }
            return false;
        }

        // Fun√ß√µes de Excel
        function handleExcelFile(file) {
            log(`üìÑ Processando arquivo: ${file.name}`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Pegar primeira planilha
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Converter para JSON
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    log(`‚úÖ Arquivo Excel processado: ${excelData.length} linhas encontradas`);
                    showExcelPreview();
                    
                } catch (error) {
                    log(`‚ùå Erro ao processar Excel: ${error.message}`);
                    alert('Erro ao processar arquivo Excel: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showExcelPreview() {
            const preview = document.getElementById('excel-preview');
            const content = document.getElementById('excel-content');
            const columnSelect = document.getElementById('name-column');
            
            if (!excelData || excelData.length === 0) {
                content.innerHTML = '<p>Nenhum dado encontrado no arquivo</p>';
                return;
            }
            
            // Mostrar preview
            preview.classList.remove('hidden');
            
            // Construir tabela de preview (m√°ximo 10 linhas)
            const previewRows = excelData.slice(0, 10);
            const table = `
                <table>
                    ${previewRows.map((row, index) => `
                        <tr>
                            ${row.map((cell, cellIndex) => `
                                <${index === 0 ? 'th' : 'td'}>
                                    ${cell || ''} ${index === 0 ? `<br><small>(Coluna ${String.fromCharCode(65 + cellIndex)})</small>` : ''}
                                </${index === 0 ? 'th' : 'td'}>
                            `).join('')}
                        </tr>
                    `).join('')}
                </table>
                ${excelData.length > 10 ? `<p><em>... e mais ${excelData.length - 10} linhas</em></p>` : ''}
            `;
            
            content.innerHTML = table;
            
            // Popular select de colunas
            columnSelect.innerHTML = '<option value="">Selecione a coluna...</option>';
            if (excelData[0]) {
                excelData[0].forEach((header, index) => {
                    const letter = String.fromCharCode(65 + index);
                    columnSelect.innerHTML += `<option value="${index}">Coluna ${letter}: ${header || 'Sem t√≠tulo'}</option>`;
                });
            }
        }

        function applyProtection() {
            const columnIndex = document.getElementById('name-column').value;
            
            if (columnIndex === '') {
                alert('Selecione a coluna com os nomes dos colaboradores');
                return;
            }
            
            protectedEmployees.clear();
            
            // Extrair nomes da coluna selecionada (pular primeira linha se for cabe√ßalho)
            const startRow = 1; // Assumir que primeira linha √© cabe√ßalho
            for (let i = startRow; i < excelData.length; i++) {
                const name = excelData[i][columnIndex];
                if (name && typeof name === 'string' && name.trim()) {
                    protectedEmployees.add(name.trim());
                }
            }
            
            log(`üõ°Ô∏è Prote√ß√£o aplicada para ${protectedEmployees.size} nomes do Excel`);
            log(`üìã Nomes protegidos: ${Array.from(protectedEmployees).join(', ')}`);
            
            // Atualizar visualiza√ß√£o
            if (employees.length > 0) {
                renderEmployeeList();
            }
            updateStats();
            
            alert(`‚úÖ Prote√ß√£o aplicada!\n\n${protectedEmployees.size} nomes foram marcados como protegidos.\n\nColaboradores com esses nomes N√ÉO poder√£o ser deletados.`);
        }

        function selectUnprotected() {
            selectedEmployees.clear();
            
            employees.forEach(emp => {
                if (!isEmployeeProtected(emp.name)) {
                    selectedEmployees.add(emp.id);
                }
            });
            
            // Marcar checkboxes
            document.querySelectorAll('input[type="checkbox"]:not([disabled])').forEach(checkbox => {
                checkbox.checked = selectedEmployees.has(checkbox.dataset.empId);
            });
            
            updateStats();
            updateEmployeeVisuals();
            document.getElementById('delete-selected').disabled = selectedEmployees.size === 0;
            log(`üéØ ${selectedEmployees.size} colaboradores n√£o protegidos selecionados para dele√ß√£o`);
        }

        function selectTestEmployees() {
            // Selecionar colaboradores que parecem ser de teste
            // (nomes gen√©ricos, emails de teste, etc.)
            const testPatterns = [
                /^(teste|test|usuario|user)\d*$/i,
                /^(funcionario|colaborador|empregado)\d*$/i,
                /^(joao|maria|jose|ana)\s*(silva|santos|oliveira|souza)$/i,
                /@(test|teste|example|temp)\.com$/i,
                /^\d+$/,  // Apenas n√∫meros
                /^[a-z]+\d+$/i  // Letra seguida de n√∫meros
            ];

            selectedEmployees.clear();
            employees.forEach(emp => {
                const isTest = testPatterns.some(pattern => 
                    pattern.test(emp.name) || 
                    pattern.test(emp.email) ||
                    (!emp.phone || emp.phone.length < 8) ||
                    (!emp.position) ||
                    (!emp.department)
                );
                
                if (isTest) {
                    selectedEmployees.add(emp.id);
                }
            });

            // Marcar checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = selectedEmployees.has(checkbox.dataset.empId);
            });

            updateStats();
            document.getElementById('delete-selected').disabled = selectedEmployees.size === 0;
            log(`üéØ ${selectedEmployees.size} colaboradores de teste selecionados`);
        }

        function selectAll() {
            selectedEmployees.clear();
            employees.forEach(emp => selectedEmployees.add(emp.id));
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });

            updateStats();
            document.getElementById('delete-selected').disabled = false;
            log(`‚òëÔ∏è Todos os ${employees.length} colaboradores selecionados`);
        }

        function clearSelection() {
            selectedEmployees.clear();
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            updateStats();
            document.getElementById('delete-selected').disabled = true;
            log('üî≤ Sele√ß√£o limpa');
        }

        async function deleteSelected() {
            if (selectedEmployees.size === 0) {
                alert('Selecione pelo menos um colaborador para deletar');
                return;
            }

            const protectedCount = protectedEmployees.size;
            const protectedMessage = protectedCount > 0 ? 
                `\n\nüõ°Ô∏è ${protectedCount} colaboradores est√£o protegidos pelo Excel e N√ÉO ser√£o deletados.` : 
                '\n\n‚ö†Ô∏è NENHUMA PROTE√á√ÉO ATIVA! Certifique-se de ter carregado a planilha de prote√ß√£o.';

            const confirmation = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                `Voc√™ est√° prestes a deletar ${selectedEmployees.size} colaboradores.\n` +
                `Esta a√ß√£o N√ÉO PODE SER DESFEITA!` +
                protectedMessage +
                `\n\nTem certeza que deseja continuar?`
            );

            if (!confirmation) {
                return;
            }

            const secondConfirmation = confirm(
                `üö® √öLTIMA CONFIRMA√á√ÉO!\n\n` +
                `Deletar ${selectedEmployees.size} colaboradores permanentemente?\n\n` +
                `Digite OK para confirmar ou Cancelar para abortar.`
            );

            if (!secondConfirmation) {
                return;
            }

            // Mostrar barra de progresso
            document.getElementById('progress-container').style.display = 'block';
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            deletedCount = 0;
            const total = selectedEmployees.size;
            const employeeIds = Array.from(selectedEmployees);

            log(`üóëÔ∏è Iniciando dele√ß√£o de ${total} colaboradores...`);

            // Deletar em batches para n√£o sobrecarregar
            const batchSize = 5;
            for (let i = 0; i < employeeIds.length; i += batchSize) {
                const batch = employeeIds.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (empId) => {
                    try {
                        await api(`/employees/${empId}`, 'DELETE');
                        deletedCount++;
                        
                        const emp = employees.find(e => e.id === empId);
                        log(`‚úÖ Deletado: ${emp ? emp.name : empId}`);
                        
                        // Atualizar progresso
                        const progress = (deletedCount / total) * 100;
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${deletedCount}/${total} colaboradores deletados (${Math.round(progress)}%)`;
                        updateStats();
                        
                    } catch (error) {
                        log(`‚ùå Erro ao deletar ${empId}: ${error.message}`);
                    }
                }));

                // Pequena pausa entre batches
                if (i + batchSize < employeeIds.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            log(`üéâ Processo conclu√≠do! ${deletedCount} colaboradores deletados de ${total} selecionados.`);
            
            // Esconder progresso ap√≥s 3 segundos
            setTimeout(() => {
                document.getElementById('progress-container').style.display = 'none';
                progressText.textContent = '';
            }, 3000);

            // Recarregar lista
            await loadEmployees();
            clearSelection();
        }

        // Event Listeners
        document.getElementById('load-employees').onclick = loadEmployees;
        document.getElementById('select-unprotected').onclick = selectUnprotected;
        document.getElementById('select-test-employees').onclick = selectTestEmployees;
        document.getElementById('select-all').onclick = selectAll;
        document.getElementById('clear-selection').onclick = clearSelection;
        document.getElementById('delete-selected').onclick = deleteSelected;
        document.getElementById('apply-protection').onclick = applyProtection;

        // Event listeners para upload de arquivo
        const fileInput = document.getElementById('excel-file');
        const dropArea = document.getElementById('file-drop-area');

        fileInput.onchange = function(e) {
            if (e.target.files.length > 0) {
                handleExcelFile(e.target.files[0]);
            }
        };

        dropArea.onclick = function() {
            fileInput.click();
        };

        // Drag and drop
        dropArea.ondragover = function(e) {
            e.preventDefault();
            dropArea.classList.add('dragover');
        };

        dropArea.ondragleave = function(e) {
            e.preventDefault();
            dropArea.classList.remove('dragover');
        };

        dropArea.ondrop = function(e) {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleExcelFile(e.dataTransfer.files[0]);
            }
        };

        // Inicializar
        updateStats();
        log('üîß Sistema de limpeza inicializado');
        log('‚ÑπÔ∏è Token encontrado, pronto para usar');
    </script>
</body>
</html>
