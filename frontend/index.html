<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MARH ‚Äî Suite de RH</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<section id="view-login" class="center">
  <div class="login-card card">
    <div class="brand"><div class="logo"></div><div><div class="pill">Prot√≥tipo ‚Ä¢ Full-stack</div><h2>MARH ‚Äî Suite de RH</h2></div></div>
    <div class="mt1"><label>E-mail</label><input id="login-email" class="input" value="admin@marh.local"></div>
    <div class="mt1"><label>Senha</label><input id="login-pass" class="input" type="password" value="123"></div>
    <div class="mt2 right"><button id="btn-login" class="btn ok">Entrar</button></div>
    <div class="note mt1"><b>Usu√°rios:</b> admin@marh.local, rh@marh.local, gestor@marh.local, colab@marh.local (senha: 123)</div>
    <div id="login-msg" class="note mt1 hidden"></div>
  </div>
</section>

<section id="view-mfa" class="center hidden">
  <div class="login-card card">
    <div class="brand"><div class="logo"></div><div><div class="pill">MFA</div><h3>Verifica√ß√£o em 2 etapas</h3></div></div>
    <div class="mt1"><label>C√≥digo</label><input id="mfa-code" class="input mono" maxlength="6"></div>
    <div id="mfa-hint" class="note mt1">‚Äî</div>
    <div class="mt2 right"><button id="btn-verify" class="btn ok">Verificar</button></div>
  </div>
</section>

<section id="app" class="hidden">
  <header class="top">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <div style="font-weight:700;font-size:1.1rem;">MARH</div>
        <div style="font-size:0.8rem;opacity:0.9;">Sistema de RH</div>
      </div>
    </div>
    <div class="toolbar" style="min-width:40%">
      <div class="search"><input id="global-search" class="input" placeholder="Buscar..."><button id="btn-search" class="btn">Buscar</button></div>
      <button id="btn-print" class="btn">üñ®Ô∏è Imprimir</button>
      <button id="btn-logout" class="btn bad">Sair</button>
    </div>
  </header>
  <div class="wrap">
    <aside>
      <div class="section">Navega√ß√£o</div>
      <nav id="menu"></nav>
      <div class="section">Sess√£o</div>
      <div class="user-ctx">
        <div class="mb1">Usu√°rio: <b id="who"></b></div>
        <div class="mb1">Perfil: <span id="role" class="badge"></span></div>
      </div>
    </aside>
    <main>
      <div id="view-dashboard" class="hidden">
        <div class="kpis">
          <div class="kpi"><div class="s">Colaboradores</div><div id="kpi-emp" class="v">0</div></div>
          <div class="kpi"><div class="s">Departamentos</div><div id="kpi-dept" class="v">0</div></div>
          <div class="kpi"><div class="s">Presen√ßas Hoje</div><div id="kpi-att" class="v">0</div></div>
          <div class="kpi"><div class="s">Afastamentos</div><div id="kpi-leaves" class="v">0</div></div>
        </div>
        <h1>Dashboard</h1>
        <p>Vis√£o geral das informa√ß√µes do sistema.</p>
      </div>
      
      <div id="view-employees" class="hidden">
        <div class="top-controls">
          <button id="btn-add-employee" class="btn ok">Novo colaborador</button>
          <button id="btn-export-employees" class="btn">Exportar CSV</button>
          <button id="btn-toggle-view" class="btn">üìã Tabela</button>
        </div>
        <div id="employees-content">
          <table id="employees-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Departamento</th>
                <th>Cargo</th>
                <th>Sal√°rio</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="employees-cards" class="hidden"></div>
        </div>
      </div>
      
      <div id="view-depts" class="hidden">
        <div class="mb1">
          <button id="btn-add-dept" class="btn ok">Novo departamento</button>
          <button id="btn-export-depts" class="btn">Exportar CSV</button>
        </div>
        <table>
          <thead><tr><th>Nome</th><th>Centro de custo</th><th>A√ß√µes</th></tr></thead>
          <tbody id="depts-tbody"></tbody>
        </table>
      </div>
      
      <div id="view-att" class="hidden">
        <div class="mb1">
          <button id="btn-add-att" class="btn ok">Registrar ponto</button>
          <button id="btn-export-att" class="btn">Exportar CSV</button>
        </div>
        <table>
          <thead><tr><th>Colaborador</th><th>Data</th><th>Entrada</th><th>Sa√≠da</th><th>Status</th><th>A√ß√µes</th></tr></thead>
          <tbody id="att-tbody"></tbody>
        </table>
      </div>
      
      <div id="view-leaves" class="hidden">
        <div class="mb1">
          <button id="btn-add-leave" class="btn ok">Novo afastamento/f√©rias</button>
          <button id="btn-export-leaves" class="btn">Exportar CSV</button>
        </div>
        <table>
          <thead><tr><th>Colaborador</th><th>Tipo</th><th>In√≠cio</th><th>Fim</th><th>Status</th><th>A√ß√µes</th></tr></thead>
          <tbody id="leaves-tbody"></tbody>
        </table>
      </div>
      
      <!-- Outras se√ß√µes permanecem iguais... -->
      <div id="view-payroll" class="hidden"><h1>Folha de Pagamento</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
      <div id="view-reviews" class="hidden"><h1>Avalia√ß√µes</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
      <div id="view-train" class="hidden"><h1>Treinamentos</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
      <div id="view-jobs" class="hidden"><h1>Vagas</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
      <div id="view-cand" class="hidden"><h1>Candidatos</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>

      <div id="view-protocol" class="hidden">
        <h1>Sistema de Protocolo</h1>
        <div class="protocol-section">
          <div id="protocol-tabs">
            <button class="active" data-tab="docs">Documentos</button>
            <button data-tab="boxes">Caixas</button>
            <button data-tab="import">Importar</button>
          </div>
          
          <div id="protocol-docs">
            <div class="mb1">
              <button id="btn-add-doc" class="btn ok">Novo documento</button>
              <button id="btn-print-label" class="btn">üñ®Ô∏è Etiqueta</button>
              <button id="btn-print-receipt" class="btn">üßæ Comprovante</button>
            </div>
            <table>
              <thead><tr><th>Protocolo</th><th>T√≠tulo</th><th>Data</th><th>Status</th><th>Caixa</th><th>A√ß√µes</th></tr></thead>
              <tbody id="protocol-docs-tbody"></tbody>
            </table>
          </div>
          
          <div id="protocol-boxes" class="hidden">
            <div class="mb1">
              <button id="btn-add-box" class="btn ok">Nova caixa</button>
              <button id="btn-print-box-label" class="btn">üñ®Ô∏è Etiqueta</button>
            </div>
            <div class="grid" id="protocol-boxes-grid"></div>
          </div>
          
          <div id="protocol-import" class="hidden">
            <h3>Importar Dados</h3>
            <div class="form">
              <label>Arquivo CSV</label>
              <input type="file" id="import-file" accept=".csv">
              <button id="btn-import" class="btn ok">Importar</button>
            </div>
            <div class="note mt1">
              <b>Formato:</b> protocolo,t√≠tulo,data,status,observa√ß√µes
            </div>
          </div>
        </div>
      </div>

      <div id="view-reports" class="hidden"><h1>Relat√≥rios</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
      <div id="view-audit" class="hidden"><h1>Logs de Auditoria</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
      <div id="view-settings" class="hidden"><h1>Configura√ß√µes de Usu√°rio</h1><div class="note">Funcionalidade em desenvolvimento.</div></div>
    </main>
  </div>
</section>

<!-- Modais -->
<div id="employee-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">Colaborador</h3>
      <button class="btn-close" onclick="closeModal('employee-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div id="employee-tabs" class="emp-tabs">
        <button class="emp-tab-btn active" data-tab="basic">Informa√ß√µes B√°sicas</button>
        <button class="emp-tab-btn" data-tab="professional">Profissional</button>
        <button class="emp-tab-btn" data-tab="hierarchy">Hierarquia</button>
        <button class="emp-tab-btn" data-tab="documents">Documentos</button>
      </div>
      
      <form id="employee-form">
        <input type="hidden" id="emp-id">
        
        <div id="tab-basic" class="tab-content">
          <div class="form-section">
            <h3>üë§ Dados Pessoais</h3>
            <div class="row">
              <div>
                <label>Nome *</label>
                <input id="emp-name" class="input" required>
              </div>
              <div>
                <label>E-mail *</label>
                <input id="emp-email" class="input" type="email" required>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Telefone</label>
                <input id="emp-phone" class="input" placeholder="(11) 99999-9999">
              </div>
              <div>
                <label>Sexo</label>
                <select id="emp-gender" class="input">
                  <option value="">Selecione...</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Feminino">Feminino</option>
                  <option value="Outro">Outro</option>
                  <option value="Prefiro n√£o informar">Prefiro n√£o informar</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Matr√≠cula</label>
                <input id="emp-badge" class="input" placeholder="N/A" readonly>
              </div>
              <div>
                <label>Status</label>
                <select id="emp-status" class="input">
                  <option value="Ativo">Ativo</option>
                  <option value="Inativo">Inativo</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div id="tab-professional" class="tab-content hidden">
          <div class="form-section">
            <h3>üíº Informa√ß√µes Profissionais</h3>
            <div class="row">
              <div>
                <label>Data de Admiss√£o</label>
                <input id="emp-hire-date" class="input" type="date">
              </div>
              <div>
                <label>In√≠cio das Atividades</label>
                <input id="emp-start-date" class="input" type="date">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Data de Demiss√£o</label>
                <input id="emp-termination-date" class="input" type="date">
              </div>
              <div>
                <label>Departamento *</label>
                <select id="emp-department" class="input" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Cargo *</label>
                <input id="emp-position" class="input" required placeholder="ex: Desenvolvedor S√™nior">
              </div>
              <div>
                <label>Sal√°rio *</label>
                <input id="emp-salary" class="input" type="number" required placeholder="8000">
              </div>
            </div>
          </div>
        </div>
        
        <div id="tab-hierarchy" class="tab-content hidden">
          <div class="form-section">
            <h3>üè¢ Hierarquia e Contatos</h3>
            <div class="row">
              <div>
                <label>Supervisor</label>
                <select id="emp-supervisor" class="input">
                  <option value="">Nenhum</option>
                </select>
              </div>
              <div>
                <label>Coordenador</label>
                <select id="emp-coordinator" class="input">
                  <option value="">Nenhum</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Gerente</label>
                <select id="emp-manager" class="input">
                  <option value="">Nenhum</option>
                </select>
              </div>
              <div>
                <label>Empresa</label>
                <input id="emp-company" class="input" placeholder="Nome da empresa">
              </div>
            </div>
            <div>
              <label>Filial</label>
              <input id="emp-branch" class="input" placeholder="Filial/Unidade">
            </div>
            <div>
              <label>Tags</label>
              <input id="emp-tags" class="input" placeholder="Separar por v√≠rgula">
            </div>
          </div>
        </div>
        
        <div id="tab-documents" class="tab-content hidden">
          <div class="form-section">
            <h3>üìÑ Documentos</h3>
            <div class="mb1">
              <button type="button" id="btn-upload-doc" class="btn ok">üì§ Upload Documento</button>
              <input type="file" id="doc-file-input" accept=".pdf" style="display: none;">
            </div>
            <div id="employee-documents">
              <div class="note">Nenhum documento encontrado.</div>
            </div>
          </div>
        </div>
        
        <div class="mt2">
          <button type="submit" class="btn ok">Salvar</button>
          <button type="button" class="btn" onclick="closeModal('employee-modal')">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const API = 'https://marhbackend-production.up.railway.app/api';
let TOKEN = localStorage.getItem('MARH_TOKEN') || null;
let ROLE = null;
let WHO = null;

function qs(s){return document.querySelector(s)} function qsa(s){return Array.from(document.querySelectorAll(s))}
function brl(v){return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
async function api(path, method='GET', body=null){
  const res = await fetch(API+path,{method,headers:{'Content-Type':'application/json', ...(TOKEN? {'Authorization':'Bearer '+TOKEN}:{})},body:body?JSON.stringify(body):null});
  if(!res.ok){ throw new Error(await res.text()) }
  return res.json();
}

// Login
qs('#btn-login').onclick = async ()=>{
  const email = qs('#login-email').value.trim(); 
  const password = qs('#login-pass').value;
  try{ 
    const r = await api('/login','POST',{email,password});
    alert('C√≥digo MFA: ' + r.demoCode);
    qs('#view-login').classList.add('hidden'); 
    qs('#view-mfa').classList.remove('hidden'); 
    qs('#mfa-hint').textContent='Digite o c√≥digo: ' + r.demoCode; 
    sessionStorage.setItem('MFA_EMAIL', email);
  }catch(e){ 
    alert('Falha no login: ' + e.message); 
  }
};
qs('#btn-verify').onclick = async ()=>{
  try{
    const email = sessionStorage.getItem('MFA_EMAIL'); 
    const code = qs('#mfa-code').value.trim();
    const r = await api('/mfa','POST',{email, code});
    TOKEN = r.token; 
    ROLE = r.role; 
    WHO = r.name; 
    localStorage.setItem('MARH_TOKEN', TOKEN); 
    initApp();
  }catch(e){ 
    alert('C√≥digo inv√°lido: ' + e.message); 
  }
};

function initApp(){
  qs('#view-mfa').classList.add('hidden'); qs('#app').classList.remove('hidden');
  qs('#who').textContent = WHO;
  qs('#role').textContent = ROLE;
  buildMenu(); bindCommon(); openView('view-dashboard');
}
function buildMenu(){
  const NAV = {
    ADMIN: [['view-dashboard','üìä Dashboard'],['view-employees','üë• Colaboradores'],['view-depts','üè¢ Departamentos'],['view-att','üïí Presen√ßas'],['view-leaves','üèñÔ∏è Afastamentos'],['view-payroll','üí∏ Folha'],['view-reviews','üìà Avalia√ß√µes'],['view-train','üéì Treinamentos'],['view-jobs','üìã Vagas'],['view-cand','üßë‚Äçüíº Candidatos'],['view-protocol','üìã Protocolo'],['view-reports','üìë Relat√≥rios'],['view-audit','üóÇÔ∏è Logs'],['view-settings','‚öôÔ∏è Usu√°rios']],
    RH: [['view-dashboard','üìä Dashboard'],['view-employees','üë• Colaboradores'],['view-depts','üè¢ Departamentos'],['view-att','üïí Presen√ßas'],['view-leaves','üèñÔ∏è Afastamentos'],['view-payroll','üí∏ Folha'],['view-reviews','üìà Avalia√ß√µes']],
    GESTOR: [['view-dashboard','üìä Dashboard'],['view-employees','üë• Colaboradores'],['view-reviews','üìà Avalia√ß√µes']],
    COLAB: [['view-dashboard','üìä Dashboard']]
  };
  qs('#menu').innerHTML = NAV[ROLE]?.map(([id, label]) => `<div><a href="#" onclick="openView('${id}')">${label}</a></div>`).join('') || '';
}
function bindCommon(){
  qs('#btn-logout').onclick = () => { localStorage.removeItem('MARH_TOKEN'); location.reload() };
}
async function openView(id){
  qsa('main > div').forEach(el => el.classList.add('hidden')); qs('#'+id).classList.remove('hidden');
  if(id==='view-employees') await loadEmployees();
  if(id==='view-depts') await loadDepts();
  if(id==='view-att') await loadAttendance();
  if(id==='view-leaves') await loadLeaves();
  if(id==='view-protocol') await loadProtocol();
  await loadSummary();
}

// Data loading functions
async function loadSummary() {
  try {
    const data = await api('/summary');
    qs('#kpi-emp').textContent = data.employees || 0;
    qs('#kpi-dept').textContent = data.departments || 0;
    qs('#kpi-att').textContent = data.attendanceToday || 0;
    qs('#kpi-leaves').textContent = data.leaves || 0;
  } catch(e) {
    console.error('Erro ao carregar resumo:', e);
  }
}

// Employee Management
let employees = [];
let isCardView = false;
let currentEmployee = null;

async function loadEmployees() {
  try {
    employees = await api('/employees');
    renderEmployees();
    await loadDepartmentsForSelect();
  } catch(e) {
    alert('Erro ao carregar colaboradores: ' + e.message);
  }
}

function renderEmployees() {
  const tbody = qs('#employees-table tbody');
  const cardsContainer = qs('#employees-cards');
  
  if (isCardView) {
    qs('#employees-table').classList.add('hidden');
    cardsContainer.classList.remove('hidden');
    cardsContainer.innerHTML = employees.map(emp => `
      <div class="employee-card" onclick="openEmployeeModal('edit', ${emp.id})">
        <h4>${emp.name}</h4>
        <div class="details">
          <div>üìß ${emp.email}</div>
          <div>üè¢ ${emp.department}</div>
          <div>üíº ${emp.position}</div>
          <div>üí∞ ${brl(emp.salary)}</div>
          <div>üìû ${emp.phone || 'N/A'}</div>
          <div>üè∑Ô∏è <span class="badge ${emp.status?.toLowerCase()}">${emp.status}</span></div>
        </div>
      </div>
    `).join('');
  } else {
    qs('#employees-table').classList.remove('hidden');
    cardsContainer.classList.add('hidden');
    tbody.innerHTML = employees.map(emp => `
      <tr onclick="openEmployeeModal('edit', ${emp.id})">
        <td>${emp.name}</td>
        <td>${emp.email}</td>
        <td>${emp.department}</td>
        <td>${emp.position}</td>
        <td>${brl(emp.salary)}</td>
        <td><span class="badge ${emp.status?.toLowerCase()}">${emp.status}</span></td>
        <td onclick="event.stopPropagation()">
          <button class="btn-small" onclick="openEmployeeModal('edit', ${emp.id})">Editar</button>
          <button class="btn-small bad" onclick="deleteEmployee(${emp.id})">Excluir</button>
        </td>
      </tr>
    `).join('');
  }
}

async function loadDepartmentsForSelect() {
  try {
    const depts = await api('/departments');
    const select = qs('#emp-department');
    select.innerHTML = '<option value="">Selecione...</option>' + 
      depts.map(dept => `<option value="${dept.name}">${dept.name}</option>`).join('');
      
    // Load employees for hierarchy selects
    const empSelects = ['#emp-supervisor', '#emp-coordinator', '#emp-manager'];
    empSelects.forEach(selector => {
      const select = qs(selector);
      select.innerHTML = '<option value="">Nenhum</option>' + 
        employees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
    });
  } catch(e) {
    console.error('Erro ao carregar departamentos:', e);
  }
}

function openEmployeeModal(action, empId = null) {
  currentEmployee = empId ? employees.find(e => e.id === empId) : null;
  
  const modal = qs('#employee-modal');
  const title = qs('#modal-title');
  const form = qs('#employee-form');
  
  title.textContent = action === 'edit' ? 'Editar Colaborador' : 'Novo Colaborador';
  modal.classList.remove('hidden');
  
  // Reset form
  form.reset();
  
  // Switch to first tab
  switchEmployeeTab('basic');
  
  if (currentEmployee) {
    // Fill form with employee data
    qs('#emp-id').value = currentEmployee.id;
    qs('#emp-name').value = currentEmployee.name || '';
    qs('#emp-email').value = currentEmployee.email || '';
    qs('#emp-phone').value = currentEmployee.phone || '';
    qs('#emp-gender').value = currentEmployee.gender || '';
    qs('#emp-badge').value = currentEmployee.badge || 'N/A';
    qs('#emp-status').value = currentEmployee.status || 'Ativo';
    qs('#emp-hire-date').value = currentEmployee.hireDate || '';
    qs('#emp-start-date').value = currentEmployee.startDate || '';
    qs('#emp-termination-date').value = currentEmployee.terminationDate || '';
    qs('#emp-department').value = currentEmployee.department || '';
    qs('#emp-position').value = currentEmployee.position || '';
    qs('#emp-salary').value = currentEmployee.salary || '';
    qs('#emp-supervisor').value = currentEmployee.supervisor || '';
    qs('#emp-coordinator').value = currentEmployee.coordinator || '';
    qs('#emp-manager').value = currentEmployee.manager || '';
    qs('#emp-company').value = currentEmployee.company || '';
    qs('#emp-branch').value = currentEmployee.branch || '';
    qs('#emp-tags').value = currentEmployee.tags || '';
    
    // Load documents
    loadEmployeeDocuments(currentEmployee.id);
  }
}

function switchEmployeeTab(tabName) {
  // Hide all tabs
  qsa('.tab-content').forEach(tab => tab.classList.add('hidden'));
  qsa('.emp-tab-btn').forEach(btn => btn.classList.remove('active'));
  
  // Show selected tab
  qs(`#tab-${tabName}`).classList.remove('hidden');
  qs(`[data-tab="${tabName}"]`).classList.add('active');
}

function closeModal(modalId) {
  qs(`#${modalId}`).classList.add('hidden');
  currentEmployee = null;
}

async function loadEmployeeDocuments(employeeId) {
  try {
    const documents = await api(`/employees/${employeeId}/documents`);
    const container = qs('#employee-documents');
    
    if (documents.length === 0) {
      container.innerHTML = '<div class="note">Nenhum documento encontrado.</div>';
      return;
    }
    
    container.innerHTML = documents.map(doc => {
      const isExpired = doc.expirationDate && new Date(doc.expirationDate) < new Date();
      const daysToExpiration = doc.expirationDate ? 
        Math.ceil((new Date(doc.expirationDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
      
      let expirationStatus = '';
      let borderColor = '#e5e7eb';
      let backgroundColor = 'white';
      let textColor = '#374151';
      
      if (isExpired) {
        expirationStatus = ' <span style="color: #dc3545; font-size: 0.8em; font-weight: bold;">[EXPIRADO]</span>';
        borderColor = '#dc3545';
        backgroundColor = '#fef2f2';
        textColor = '#991b1b';
      } else if (daysToExpiration !== null && daysToExpiration <= 30 && daysToExpiration > 0) {
        expirationStatus = ` <span style="color: #ffc107; font-size: 0.8em; font-weight: bold;">[EXPIRA EM ${daysToExpiration} DIAS]</span>`;
        borderColor = '#ffc107';
        backgroundColor = '#fffbf0';
        textColor = '#856404';
      }
      
      const expirationInfo = doc.expirationDate ? 
        `üìÖ Expira: ${doc.expirationDate}` : 'üìÖ Sem data de expira√ß√£o';
      
      return `
        <div style="border: 1px solid ${borderColor}; background: ${backgroundColor}; color: ${textColor}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem;">
          <div style="font-weight: 500; margin-bottom: 0.5rem;">
            üìÑ ${doc.description || doc.type}${expirationStatus}
          </div>
          <div style="font-size: 0.85em; color: #6c757d;">
            üìÖ Upload: ${doc.uploadDate} ‚Ä¢ üì¶ ${doc.size || formatFileSize(doc.fileSize)}
          </div>
          <div style="font-size: 0.8em; color: ${isExpired ? '#dc3545' : (daysToExpiration !== null && daysToExpiration <= 30 && daysToExpiration > 0) ? '#856404' : '#6c757d'}; margin-top: 2px;">
            ${expirationInfo}
          </div>
          ${doc.notes ? `<div style="font-size: 0.8em; color: #28a745; margin-top: 2px;">üí¨ ${doc.notes}</div>` : ''}
          <div style="margin-top: 0.5rem;">
            <button class="btn-small" onclick="viewDocument('${doc.filename}')">üëÅÔ∏è Visualizar</button>
            <button class="btn-small bad" onclick="deleteDocument(${doc.id})">üóëÔ∏è Excluir</button>
          </div>
        </div>
      `;
    }).join('');
  } catch(e) {
    qs('#employee-documents').innerHTML = '<div class="note">Erro ao carregar documentos.</div>';
    console.error('Erro ao carregar documentos:', e);
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

async function viewDocument(filename) {
  try {
    window.open(`${API}/documents/${filename}`, '_blank');
  } catch(e) {
    alert('Erro ao abrir documento: ' + e.message);
  }
}

async function deleteDocument(docId) {
  if (!confirm('Tem certeza que deseja excluir este documento?')) return;
  
  try {
    await api(`/documents/${docId}`, 'DELETE');
    alert('Documento exclu√≠do com sucesso!');
    if (currentEmployee) {
      loadEmployeeDocuments(currentEmployee.id);
    }
  } catch(e) {
    alert('Erro ao excluir documento: ' + e.message);
  }
}

// Event bindings
qs('#employee-tabs').addEventListener('click', (e) => {
  if (e.target.dataset.tab) {
    switchEmployeeTab(e.target.dataset.tab);
  }
});

qs('#btn-add-employee').onclick = () => openEmployeeModal('add');
qs('#btn-toggle-view').onclick = () => {
  isCardView = !isCardView;
  qs('#btn-toggle-view').textContent = isCardView ? 'üìã Tabela' : 'üóÇÔ∏è Cards';
  renderEmployees();
};

qs('#employee-form').onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());
  
  try {
    const method = data.id ? 'PUT' : 'POST';
    const url = data.id ? `/employees/${data.id}` : '/employees';
    await api(url, method, data);
    
    alert(data.id ? 'Colaborador atualizado!' : 'Colaborador criado!');
    closeModal('employee-modal');
    loadEmployees();
  } catch(e) {
    alert('Erro ao salvar: ' + e.message);
  }
};

qs('#btn-upload-doc').onclick = () => qs('#doc-file-input').click();

qs('#doc-file-input').onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  if (file.type !== 'application/pdf') {
    alert('Apenas arquivos PDF s√£o aceitos.');
    return;
  }
  
  const description = prompt('Descri√ß√£o do documento:', file.name);
  if (!description) return;
  
  const expirationDate = prompt('Data de expira√ß√£o (YYYY-MM-DD) - opcional:');
  const notes = prompt('Observa√ß√µes - opcional:');
  
  const formData = new FormData();
  formData.append('file', file);
  formData.append('employeeId', currentEmployee.id);
  formData.append('description', description);
  if (expirationDate) formData.append('expirationDate', expirationDate);
  if (notes) formData.append('notes', notes);
  
  try {
    await fetch(API + '/documents/upload', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + TOKEN },
      body: formData
    });
    
    alert('Documento enviado com sucesso!');
    loadEmployeeDocuments(currentEmployee.id);
    e.target.value = ''; // Clear input
  } catch(e) {
    alert('Erro ao enviar documento: ' + e.message);
  }
};

async function deleteEmployee(id) {
  if (!confirm('Tem certeza que deseja excluir este colaborador?')) return;
  try {
    await api(`/employees/${id}`, 'DELETE');
    alert('Colaborador exclu√≠do!');
    loadEmployees();
  } catch(e) {
    alert('Erro ao excluir: ' + e.message);
  }
}

// Other functions (departments, attendance, leaves, protocol) remain the same...
async function loadDepts() {
  try {
    const depts = await api('/departments');
    qs('#depts-tbody').innerHTML = depts.map(dept => `
      <tr>
        <td>${dept.name}</td>
        <td>${dept.costCenter}</td>
        <td>
          <button class="btn-small" onclick="editDept(${dept.id})">Editar</button>
          <button class="btn-small bad" onclick="deleteDept(${dept.id})">Excluir</button>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    alert('Erro ao carregar departamentos: ' + e.message);
  }
}

async function loadAttendance() {
  try {
    const att = await api('/attendance');
    qs('#att-tbody').innerHTML = att.map(a => `
      <tr>
        <td>${a.employee || '-'}</td>
        <td>${a.date}</td>
        <td>${a.checkIn}</td>
        <td>${a.checkOut}</td>
        <td>${a.status}</td>
        <td>
          <button class="btn-small" onclick="editAttendance(${a.id})">Editar</button>
          <button class="btn-small bad" onclick="deleteAttendance(${a.id})">Excluir</button>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    alert('Erro ao carregar presen√ßas: ' + e.message);
  }
}

async function loadLeaves() {
  try {
    const leaves = await api('/leaves');
    qs('#leaves-tbody').innerHTML = leaves.map(leave => `
      <tr>
        <td>${leave.employee || '-'}</td>
        <td>${leave.type}</td>
        <td>${leave.startDate}</td>
        <td>${leave.endDate}</td>
        <td>${leave.status}</td>
        <td>
          <button class="btn-small" onclick="editLeave(${leave.id})">Editar</button>
          <button class="btn-small bad" onclick="deleteLeave(${leave.id})">Excluir</button>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    alert('Erro ao carregar afastamentos: ' + e.message);
  }
}

// Protocol system
let currentDoc = null;
let currentBox = null;

async function loadProtocol() {
  await Promise.all([loadProtocolDocs(), loadProtocolBoxes()]);
}

async function loadProtocolDocs() {
  try {
    const docs = await api('/protocol/documents');
    qs('#protocol-docs-tbody').innerHTML = docs.map(doc => `
      <tr onclick="selectDoc(${doc.id})">
        <td>${doc.protocol}</td>
        <td>${doc.title}</td>
        <td>${doc.date}</td>
        <td><span class="badge ${doc.status.toLowerCase()}">${doc.status}</span></td>
        <td>${doc.box || '-'}</td>
        <td onclick="event.stopPropagation()">
          <button class="btn-small" onclick="editProtocolDoc(${doc.id})">Editar</button>
          <button class="btn-small bad" onclick="deleteProtocolDoc(${doc.id})">Excluir</button>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    console.error('Erro ao carregar documentos do protocolo:', e);
  }
}

async function loadProtocolBoxes() {
  try {
    const boxes = await api('/protocol/boxes');
    qs('#protocol-boxes-grid').innerHTML = boxes.map(box => `
      <div class="card" onclick="selectBox(${box.id})" style="cursor: pointer; ${currentBox?.id === box.id ? 'border-color: var(--brand);' : ''}">
        <h4>${box.code}</h4>
        <p><strong>Local:</strong> ${box.location}</p>
        <p><strong>Documentos:</strong> ${box.docCount || 0}</p>
        <p><strong>Status:</strong> <span class="badge ${box.status?.toLowerCase()}">${box.status}</span></p>
        <div class="mt1">
          <button class="btn-small" onclick="event.stopPropagation(); editProtocolBox(${box.id})">Editar</button>
          <button class="btn-small bad" onclick="event.stopPropagation(); deleteProtocolBox(${box.id})">Excluir</button>
        </div>
      </div>
    `).join('');
  } catch(e) {
    console.error('Erro ao carregar caixas do protocolo:', e);
  }
}

function selectDoc(id) {
  // Implementation for document selection
}

function selectBox(id) {
  // Implementation for box selection
}

// Protocol tabs
qs('#protocol-tabs').addEventListener('click', (e) => {
  if (e.target.dataset.tab) {
    const tab = e.target.dataset.tab;
    
    // Update active tab
    qsa('#protocol-tabs button').forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    
    // Show/hide content
    qs('#protocol-docs').classList.toggle('hidden', tab !== 'docs');
    qs('#protocol-boxes').classList.toggle('hidden', tab !== 'boxes');
    qs('#protocol-import').classList.toggle('hidden', tab !== 'import');
  }
});

// Bootstrap
if(TOKEN){
  fetch(API+'/summary',{headers:{'Authorization':'Bearer '+TOKEN}}).then(r=>{ if(r.ok){ ROLE='ADMIN'; WHO='Admin MARH'; initApp(); } }).catch(()=>{});
}
</script>
</body>
</html>
